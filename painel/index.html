<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel | ConecTexxto</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css">

  <style>
    .wrap{min-height:calc(100vh - 70px - 64px);padding:28px 20px 60px;}
    .panel{max-width:900px;margin:0 auto;}
    .box{background:#081426;border-radius:16px;padding:20px;margin-bottom:18px;box-shadow:0 10px 25px rgba(0,0,0,.35);}
    .welcome h1{font-size:26px;margin-bottom:6px;}
    .welcome p{opacity:.88;line-height:1.6;}
    textarea{width:100%;min-height:90px;border-radius:12px;padding:12px;border:1px solid rgba(30,144,255,.35);background:#050B18;color:#F5F7FA;outline:none;resize:none;}
    textarea:focus{border-color:#1E90FF;box-shadow:0 0 0 3px rgba(30,144,255,.15);}
    .btn2{margin-top:10px;padding:10px 16px;border-radius:10px;border:none;background:#1E90FF;color:#fff;font-weight:600;cursor:pointer;}
    .btn2:hover{filter:brightness(.95);}
    .post h4{margin-bottom:6px;}
    .post small{opacity:.6;}
    .err{border:1px solid rgba(255,80,80,.35);background:rgba(255,80,80,.08);}
    .ok{border:1px solid rgba(0,200,120,.35);background:rgba(0,200,120,.06);}
  </style>
</head>

<body>
  <header>
    <div class="logo">Conec<span>Texxto</span></div>
    <nav>
      <a href="../">InÃ­cio</a>
      <a href="#" id="logout" class="btn">Sair</a>
      <a href="../perfil/" class="btn">Perfil</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="panel">

      <!-- PERFIL / BOAS-VINDAS -->
      <div class="box welcome">
        <h1 id="hello">Bem-vindo(a) ðŸ‘‹</h1>
        <p id="desc">Carregando seu perfil...</p>
      </div>

      <!-- NOVA POSTAGEM -->
      <div class="box">
        <h3>ðŸ’¬ Criar postagem</h3>
        <textarea id="content" placeholder="O que vocÃª estÃ¡ pensando?"></textarea>
        <button class="btn2" id="postBtn">Publicar</button>
        <p id="postMsg" style="margin-top:10px;opacity:.85;"></p>
      </div>

      <!-- FEED -->
      <div id="feedMsg" class="box" style="display:none;"></div>
      <div id="feed"></div>

    </section>
  </main>

  <footer>Â© 2026 ConecTexxto Â· Projeto em desenvolvimento</footer>

  <script type="module">
    import { supabase } from "../supabase.js";

    const hello = document.getElementById("hello");
    const desc = document.getElementById("desc");

    const feed = document.getElementById("feed");
    const feedMsg = document.getElementById("feedMsg");
    const postBtn = document.getElementById("postBtn");
    const contentInput = document.getElementById("content");
    const postMsg = document.getElementById("postMsg");

    function showBox(el, type, text){
      el.style.display = "block";
      el.className = "box " + (type || "");
      el.textContent = text;
    }

    // ProteÃ§Ã£o: sÃ³ entra logado
    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData?.session;
    if (!session) window.location.href = "../login/";

    const user = session.user;

    // Logout
    document.getElementById("logout").onclick = async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      window.location.href = "../login/";
    };

    // Carregar perfil
    async function loadProfile(){
      const { data: profile, error } = await supabase
        .from("profiles")
        .select("nome, idade")
        .eq("id", user.id)
        .single();

      if (error || !profile){
        hello.textContent = "Bem-vindo(a) ðŸ‘‹";
        desc.textContent = "NÃ£o consegui carregar seu perfil agora.";
        return;
      }

      hello.textContent = `Bem-vindo(a), ${profile.nome}! ðŸ‘‹`;
      desc.textContent = `Sua idade: ${profile.idade ?? "â€”"}.`;
    }

    // Criar post
    postBtn.onclick = async () => {
      const content = contentInput.value.trim();
      if (!content) {
        postMsg.textContent = "Digite algo antes de publicar.";
        return;
      }

      postMsg.textContent = "Publicando...";

      const { error } = await supabase.from("posts").insert({
        user_id: user.id,
        content
      });

      if (error){
        postMsg.textContent = "Erro ao publicar: " + error.message;
        return;
      }

      postMsg.textContent = "Publicado âœ…";
      contentInput.value = "";
      await loadFeed();
    };

    // Carregar feed (com join certo)
    async function loadFeed(){
      feed.innerHTML = "";
      feedMsg.style.display = "none";

      const { data, error } = await supabase
        .from("posts")
        .select("id, content, created_at, profiles(nome)")
        .order("created_at", { ascending: false });

      if (error){
        showBox(feedMsg, "err", "Erro ao carregar feed: " + error.message);
        return;
      }

      if (!data || data.length === 0){
        showBox(feedMsg, "ok", "Ainda nÃ£o hÃ¡ postagens. Seja o primeiro a postar ðŸ˜Š");
        return;
      }

      for (const post of data){
        const div = document.createElement("div");
        div.className = "box post";
        div.innerHTML = `
          <h4>${post.profiles?.nome || "UsuÃ¡rio"}</h4>
          <p>${escapeHtml(post.content)}</p>
          <small>${new Date(post.created_at).toLocaleString()}</small>
        `;
        feed.appendChild(div);
      }
    }

    // SeguranÃ§a bÃ¡sica contra HTML em post
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    await loadProfile();
    await loadFeed();
  </script>
</body>
</html>
